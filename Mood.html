<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          primary: "#13ec13",
          "background-light": "#1a1a1a",
          "background-dark": "#101010",
          "surface-dark": "#1f1f1f",
          "text-muted": "#888888",
          "text-subtle": "#555555",
        },
        fontFamily: { display: ["Inter"] },
      }
    }
  }
</script>
<title>Daily Quiz — Mood Tracker</title>
<style> body { min-height: 100vh; } </style>
</head>
<body class="bg-background-dark font-display text-neutral-200">
<div class="flex h-full min-h-screen w-full flex-col">
  <header class="sticky top-0 z-10 bg-background-dark/80 px-4 py-3 backdrop-blur-sm">
    <div class="flex items-center">
      <button class="flex h-10 w-10 items-center justify-center rounded-full text-neutral-400 hover:bg-surface-dark interactive-element" aria-label="back">
        ‹
      </button>
      <h1 class="flex-1 text-center text-lg font-bold text-neutral-100">Mood Tracker</h1>
      <div class="h-10 w-10"></div>
    </div>
  </header>

  <main class="flex-1 px-4 py-6">
    <div class="mx-auto max-w-md">

      <section class="mb-8 text-center">
        <h2 class="text-3xl font-bold text-neutral-100">How are you feeling today?</h2>
        <p class="mt-2 text-text-muted">Your thoughts are safe here. Take a moment for yourself.</p>
      </section>

      <!-- DAILY QUIZ -->
      <section id="daily-quiz" class="mb-8 rounded-xl bg-surface-dark p-5 shadow-lg">
        <div class="flex items-center justify-between mb-3">
          <div>
            <h3 class="text-lg font-bold text-neutral-100">Daily 5-Question Check</h3>
            <p class="text-sm text-text-muted">Answer 5 quick statements to get a daily mood snapshot.</p>
          </div>
          <div id="quizDateLabel" class="text-sm text-text-subtle"></div>
        </div>

        <form id="quizForm" class="space-y-4">
          <div id="questionsList" class="space-y-3"></div>

          <div class="flex items-center gap-3">
            <button id="submitQuizBtn" type="submit" class="px-4 py-2 bg-primary text-black rounded-lg">Submit Quiz</button>
            <button id="skipQuizBtn" type="button" class="px-4 py-2 border rounded-lg">Skip</button>
            <div id="quizStatus" class="text-sm text-text-subtle"></div>
          </div>
        </form>

        <div id="quizResult" class="mt-4 hidden border-t pt-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm text-text-muted">Today's quiz</div>
              <div id="quizMoodLabel" class="text-2xl font-bold text-neutral-100">—</div>
              <div id="quizScoreLabel" class="text-sm text-text-subtle"></div>
            </div>
            <div>
              <button id="retakeQuizBtn" class="px-3 py-2 border rounded-lg">Retake</button>
            </div>
          </div>

          <div id="quizNoteArea" class="mt-3">
            <label class="text-sm text-neutral-200">Add a note (optional)</label>
            <textarea id="quizNote" rows="3" class="w-full mt-2 p-2 border rounded bg-background-dark text-neutral-200" placeholder="How are you feeling?"></textarea>
            <div class="mt-2 flex gap-2">
              <button id="saveQuizNoteBtn" class="px-4 py-2 bg-primary text-black rounded-lg">Save Note</button>
              <button id="clearQuizNoteBtn" class="px-4 py-2 border rounded-lg">Clear</button>
            </div>
          </div>
        </div>

        <div id="pastResults" class="mt-6">
          <h4 class="text-sm font-semibold text-neutral-200 mb-2">Past quizzes (last 14 days)</h4>
          <div id="pastList" class="space-y-2 text-sm text-text-muted"></div>
        </div>
      </section>
      <!-- END DAILY QUIZ -->

    </div>
  </main>

  <footer class="sticky bottom-0 border-t border-neutral-700 bg-background-dark/80 pb-4 pt-2 backdrop-blur-sm">
    <nav class="flex justify-around">
      <a class="flex flex-col items-center gap-1 text-text-muted hover:text-neutral-200" href="#"><span class="text-xs font-medium">Home</span></a>
      <a class="flex flex-col items-center gap-1 text-primary" href="#"><span class="text-xs font-bold">Mood</span></a>
    </nav>
  </footer>
</div>

<script>
/*
  Robust daily 5-question quiz.
  Wait for DOMContentLoaded then initialize.
*/
document.addEventListener('DOMContentLoaded', function () {
  // question bank
  const QUESTION_BANK = [
    "I felt calm and relaxed today.",
    "I was able to concentrate on tasks without much distraction.",
    "I felt hopeful about my future.",
    "I managed my worries effectively today.",
    "I felt connected to others (friends/family) today.",
    "I felt overwhelmed by tasks or responsibilities.",
    "I experienced physical symptoms of stress (e.g., tense muscles).",
    "I slept well last night.",
    "I felt motivated to study or work today.",
    "I found time to relax or do something I enjoy."
  ];

  // DOM refs
  const quizDateLabel = document.getElementById('quizDateLabel');
  const questionsList = document.getElementById('questionsList');
  const quizForm = document.getElementById('quizForm');
  const quizResult = document.getElementById('quizResult');
  const quizMoodLabel = document.getElementById('quizMoodLabel');
  const quizScoreLabel = document.getElementById('quizScoreLabel');
  const quizNote = document.getElementById('quizNote');
  const saveQuizNoteBtn = document.getElementById('saveQuizNoteBtn');
  const clearQuizNoteBtn = document.getElementById('clearQuizNoteBtn');
  const pastList = document.getElementById('pastList');
  const submitQuizBtn = document.getElementById('submitQuizBtn');
  const skipQuizBtn = document.getElementById('skipQuizBtn');
  const retakeQuizBtn = document.getElementById('retakeQuizBtn');

  if (!questionsList) {
    // show error on page if container not found
    const err = document.createElement('div');
    err.className = 'text-red-400';
    err.textContent = 'Quiz failed to load (questions container missing).';
    document.getElementById('daily-quiz').prepend(err);
    console.error('questionsList element not found');
    return;
  }

  // date helpers
  function todayKey(){ return new Date().toISOString().slice(0,10); }
  function storageKeyForDate(d){ return 'daily_quiz_' + d; }

  // seeded shuffle (deterministic each day)
  function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h = Math.imul(h ^ s.charCodeAt(i), 16777619) >>> 0; } return h; }
  function mulberry32(a){ return function(){ var t = a += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
  function seededShuffle(arr, seed){
    const out = arr.slice(); const rnd = mulberry32(hashStr(seed));
    for (let i = out.length - 1; i > 0; i--) {
      const j = Math.floor(rnd() * (i + 1));
      [out[i], out[j]] = [out[j], out[i]];
    }
    return out;
  }

  // escape
  function escapeHtml(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // build today's questions
  const today = todayKey();
  quizDateLabel.textContent = new Date().toLocaleDateString();
  const todaysQuestions = seededShuffle(QUESTION_BANK, today).slice(0,5);

  // render
  function renderQuestions() {
    questionsList.innerHTML = '';
    todaysQuestions.forEach((q, idx) => {
      const id = 'q-' + idx;
      const wrapper = document.createElement('div');
      wrapper.className = 'space-y-1';
      wrapper.innerHTML = `
        <div class="text-sm font-medium text-neutral-200">${escapeHtml(q)}</div>
        <div class="flex items-center gap-2 text-xs text-text-muted">
          ${[0,1,2,3,4].map(v => `
            <label class="flex items-center gap-2">
              <input name="${id}" type="radio" value="${v}" class="form-radio" ${v===2?'checked':''} />
              <span class="w-6 text-center">${v}</span>
            </label>
          `).join('')}
          <div class="ml-3 text-xs text-text-muted">0=Never · 4=Always</div>
        </div>
      `;
      questionsList.appendChild(wrapper);
    });
  }

  // compute score
  function computeScore(answers){
    const sum = answers.reduce((s,a)=>s + (Number(a)||0),0);
    const avg = sum / answers.length;
    const moodValue = Math.round((avg / 4) * 4) + 1; // map 0..4 -> 1..5
    let moodLabel = 'Neutral';
    if (avg >= 3.25) moodLabel = 'Positive';
    else if (avg >= 1.75) moodLabel = 'Neutral';
    else moodLabel = 'Low';
    return { sum, avg, moodValue, moodLabel };
  }

  // storage helpers
  function saveResult(dateStr, payload){ try { localStorage.setItem(storageKeyForDate(dateStr), JSON.stringify(payload)); } catch(e){ console.warn(e); } }
  function loadResult(dateStr){ try { const raw = localStorage.getItem(storageKeyForDate(dateStr)); return raw ? JSON.parse(raw) : null; } catch { return null; } }

  // past rendering
  function renderPast(){
    pastList.innerHTML = '';
    for (let i=0;i<14;i++){
      const d = new Date(); d.setDate(d.getDate() - i);
      const key = d.toISOString().slice(0,10);
      const res = loadResult(key);
      const el = document.createElement('div');
      el.className = 'flex items-center justify-between p-2 rounded';
      if (res) el.innerHTML = `<div class="text-sm">${new Date(key).toLocaleDateString()}</div><div class="text-sm font-semibold">${escapeHtml(res.moodLabel)} (${Math.round(res.avg*100)/100})</div>`;
      else el.innerHTML = `<div class="text-sm">${new Date(key).toLocaleDateString()}</div><div class="text-sm text-text-muted">no entry</div>`;
      pastList.appendChild(el);
    }
  }

  // show result UI
  function showResult(payload){
    quizResult.classList.remove('hidden');
    quizMoodLabel.textContent = payload.moodLabel + ' • mood ' + payload.moodValue;
    quizScoreLabel.textContent = 'Score: ' + (Math.round(payload.avg * 100) / 100) + ' (avg)';
    quizNote.value = payload.note || '';
    // disable radios and submit to prevent accidental changes
    setFormDisabled(true);
  }

  function setFormDisabled(disabled){
    const inputs = quizForm.querySelectorAll('input[type="radio"]');
    inputs.forEach(i => i.disabled = disabled);
    submitQuizBtn.disabled = disabled;
    skipQuizBtn.disabled = disabled;
  }

  // init
  renderQuestions();
  const existing = loadResult(today);
  if (existing) {
    if (existing.skipped) {
      quizResult.classList.remove('hidden');
      quizMoodLabel.textContent = 'Skipped';
      quizScoreLabel.textContent = '';
      setFormDisabled(true);
    } else {
      showResult(existing);
    }
  } else {
    setFormDisabled(false);
  }
  renderPast();

  // submit handler
  quizForm.addEventListener('submit', function(e){
    e.preventDefault();
    // collect answers
    const answers = [];
    for (let i=0;i<todaysQuestions.length;i++){
      const radios = document.getElementsByName('q-' + i);
      let val = null;
      for (const r of radios) if (r.checked) { val = Number(r.value); break; }
      if (val === null) { alert('Please answer all questions'); return; }
      answers.push(val);
    }
    const computed = computeScore(answers);
    const payload = { date: today, answers, sum: computed.sum, avg: computed.avg, moodValue: computed.moodValue, moodLabel: computed.moodLabel, note: quizNote.value||'', createdAt: new Date().toISOString() };
    saveResult(today, payload);
    showResult(payload);
    renderPast();

    // optional: save as mood entry for trend (simple model)
    try {
      const MOOD_KEY = 'mood_entries_v1';
      const raw = localStorage.getItem(MOOD_KEY) || '[]';
      const arr = JSON.parse(raw);
      arr.push({ id:'q-'+Date.now(), mood: computed.moodValue, note: payload.note, createdAt: new Date().toISOString() });
      localStorage.setItem(MOOD_KEY, JSON.stringify(arr));
    } catch(e){ console.warn('saving mood entry failed', e); }
  });

  // skip
  skipQuizBtn.addEventListener('click', function(){
    if (!confirm("Skip today's quiz?")) return;
    saveResult(today, { date: today, skipped: true, createdAt: new Date().toISOString() });
    setFormDisabled(true);
    quizResult.classList.remove('hidden');
    quizMoodLabel.textContent = 'Skipped';
    quizScoreLabel.textContent = '';
    renderPast();
  });

  // retake
  retakeQuizBtn.addEventListener('click', function(){
    if (!confirm("Retake will overwrite today's result. Continue?")) return;
    localStorage.removeItem(storageKeyForDate(today));
    setFormDisabled(false);
    quizResult.classList.add('hidden');
    // reset radios to default
    for (let i=0;i<todaysQuestions.length;i++){
      const radios = document.getElementsByName('q-'+i);
      radios.forEach(r => r.checked = (r.value === '2'));
    }
    quizNote.value = '';
    renderPast();
  });

  // save note
  if (saveQuizNoteBtn) saveQuizNoteBtn.addEventListener('click', function(){
    const saved = loadResult(today);
    if (!saved) { alert('Please submit the quiz first.'); return; }
    saved.note = quizNote.value || '';
    saveResult(today, saved);
    alert('Note saved.');
    renderPast();
  });
  if (clearQuizNoteBtn) clearQuizNoteBtn.addEventListener('click', ()=> quizNote.value = '');

}); // DOMContentLoaded
</script>
</body>
</html>
